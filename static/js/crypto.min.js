"use strict"
var scrypt=scrypt_module_factory(134217728),nacl=nacl_factory.instantiate(),incNonce=function(e){var n=e.length-1
if(e[n]+=2,e[n]<2)do--n,e[n]+=1
while(n>0&&e[n]<1)},joinUser=function(e,n){var o=nacl.crypto_box_keypair(),c=nacl.crypto_sign_keypair(),a=(nacl.crypto_box_random_nonce(),nacl.random_bytes(16)),r=scrypt.crypto_scrypt(scrypt.encode_utf8(n),a,65536,8,1,32),s=nacl.crypto_secretbox_random_nonce(),t=nacl.to_hex(o.boxSk)+":"+nacl.to_hex(c.signSk)
t=nacl.crypto_secretbox(nacl.encode_latin1(t),s,r)
var l=null
return $.ajax({url:"/login/"+e,type:"POST",contentType:"application/json",async:!1,data:JSON.stringify({salt:nacl.to_hex(a),nonce:nacl.to_hex(s),pk:nacl.to_hex(o.boxPk),signpk:nacl.to_hex(c.signPk),sk:nacl.to_hex(t)})}).done(function(e){if(e.hasOwnProperty("res")){var n=nacl.from_hex(e.res.session.pk),a=nacl.crypto_box_precompute(n,o.boxSk),s=nacl.from_hex(e.res.session.sessNonce),t=nacl.from_hex(e.res.session.nonce)
s=nacl.crypto_box_open_precomputed(s,t,a),l={sk:o.boxSk,signSk:c.signSk,sessionNonce:s,sessionKey:a,k:r}}}),l},loginUser=function(e,n){var o=null
return $.ajax({url:"/login/"+e,type:"GET",async:!1}).done(function(e){if(e.hasOwnProperty("res")){var c=nacl.from_hex(e.res.user.nonce),a=nacl.from_hex(e.res.user.salt),r=(nacl.from_hex(e.res.user.pk),nacl.from_hex(e.res.user.sk)),s=nacl.from_hex(e.res.session.sessNonce),t=nacl.from_hex(e.res.session.pk),l=nacl.from_hex(e.res.session.nonce),i=e.res.user.p||null
i&&i.hasOwnProperty("nonce")&&i.hasOwnProperty("data")&&(i.nonce=nacl.from_hex(i.nonce),i.data=nacl.from_hex(i.data))
var p=scrypt.crypto_scrypt(scrypt.encode_utf8(n),a,65536,8,1,32)
try{r=nacl.crypto_secretbox_open(r,c,p),r=nacl.decode_latin1(r).split(":")
var _=nacl.from_hex(r[1])
r=nacl.from_hex(r[0])
var d=nacl.crypto_box_precompute(t,r)
s=nacl.crypto_box_open_precomputed(s,l,d),i&&(i=nacl.decode_utf8(nacl.crypto_secretbox_open(i.data,i.nonce,p))),o={sk:r,signSk:_,sessionNonce:s,sessionKey:d,k:p,p:i}}catch(y){console.log(y.message)}}}),o},updateUser=function(e){var n=nacl.crypto_box_random_nonce(),o={nonce:nacl.to_hex(n)},c=JSON.stringify({fullname:e})
c=nacl.crypto_secretbox(nacl.encode_utf8(e),n,PMail.k),o.data=nacl.to_hex(c),$.ajax({url:"/login/"+PMail.username,type:"PUT",async:!1,contentType:"application/json",data:JSON.stringify({req:encodeRequest({p:o})})}).done(function(){})},decodeMail=function(e){PMail.sk&&e.forEach(function(e){var n=nacl.from_hex(e.nonce),o=nacl.from_hex(e.pk),c=nacl.from_hex(e.body)
try{var a=nacl.crypto_box_open(c,n,o,PMail.sk),r=JSON.parse(nacl.decode_utf8(a))
e.subject=r.subject||"No subject",e.body=r.html?$(document.createElement("div")).append($.parseHTML(r.html)).html():r.text||"",r.from&&r.from.length>0&&(e.from=r.from),r.to&&r.to.length>0&&(e.to=r.to),r.headers&&r.headers.date&&(e.date=r.headers.date),e.visible=!0,delete e.pk,delete e.nonce,delete e.username,PMail.searchindex.add({id:e.id,subject:e.subject||"",body:e.body||"",from:e.from?PMail.recipentListToString(e.from)||"":"",to:e.to?PMail.recipentListToString(e.to)||"":"",date:e.date||""})}catch(s){console.log("error decode:",e.id,s)}})},decodeResponse=function(e){if(!e.hasOwnProperty("res"))return null
var n=PMail.sessionNonce
return incNonce(PMail.sessionNonce),JSON.parse(nacl.decode_utf8(nacl.crypto_box_open_precomputed(nacl.from_hex(e.res),n,PMail.sessionKey)))},newMail=function(e){var n=$.Deferred()
e&&e.to&&PMail.signSk||n.reject()
for(var o=[],c=[],a=RegExp("^(.+)@"+PMail.domain+"$","i"),r=RegExp("^(.+)@(.+)$","i"),s=0;s<e.to.length;s++)if(r.exec(e.to[s].address)){var t=a.exec(e.to[s].address)
t?o.push(t[1]):c.push({body:JSON.stringify(e)})}else o.push(e.to[s].address)
return $.ajax({url:"/users",type:"GET",data:{req:encodeRequest({users:o})}}).then(function(a){for(var r=decodeResponse(a).users,s=nacl.encode_utf8(JSON.stringify(e)),t=0;t<o.length;t++){var l=o[t]
if(r[l]){{var i=nacl.crypto_box_keypair_from_seed(nacl.random_bytes(64)),p=nacl.crypto_box_random_nonce(),_=nacl.from_hex(r[l].pk),d=nacl.crypto_sign_keypair()
nacl.crypto_sign(s,d.signSk)}c.push({username:l,pk:nacl.to_hex(i.boxPk),nonce:nacl.to_hex(p),body:nacl.to_hex(nacl.crypto_box(s,p,_,i.boxSk)),sign:nacl.to_hex(nacl.crypto_sign(s,PMail.signSk))})}}$.ajax({url:"/send",type:"POST",contentType:"application/json",data:JSON.stringify({req:encodeRequest({mails:c})})}).done(function(){n.resolve()}).fail(function(){n.reject()})}),n},encodeRequest=function(e){if(PMail.sessionKey&&PMail.sessionNonce){var n=PMail.sessionNonce
incNonce(PMail.sessionNonce)
var o=nacl.encode_utf8(JSON.stringify(e))
return nacl.to_hex(nacl.crypto_box_precomputed(o,n,PMail.sessionKey))}}
