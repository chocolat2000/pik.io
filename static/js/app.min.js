"use strict"
window.PMail=Ember.Application.create(),PMail.searchindex=null,PMail.domain="pik.io",PMail.username=null,PMail.sk=null,PMail.sessionNonce=null,PMail.sessionKey=null,PMail.k=null,PMail.Router.map(function(){this.route("login"),this.route("compose"),this.route("profile"),this.resource("inbox",function(){this.route("mail",{path:"/:mail_id"})}),this.resource("sent",function(){this.route("mail",{path:"/:mail_id"})}),this.resource("trash",function(){this.route("mail",{path:"/:mail_id"})})}),PMail.ApplicationController=Ember.ObjectController.extend({isLoggedIn:!1,fullname:""}),PMail.LoginController=Ember.ObjectController.extend({needs:"application",username:null,password:null,repeat:null,isJoining:!1,errorMessage:null,fullname:Ember.computed.alias("controllers.application.fullname"),isLoggedIn:Ember.computed.alias("controllers.application.isLoggedIn"),actions:{changeJoin:function(){this.set("isJoining",!this.get("isJoining"))}}}),PMail.LoginRoute=Em.Route.extend({actions:{login:function(){var e=this.get("controller")
e.set("errorMessage",null)
var t=loginUser(e.get("username"),e.get("password"))
t&&t.sk&&t.sessionKey?(PMail.username=e.get("username"),PMail.sk=t.sk,PMail.sessionNonce=t.sessionNonce,PMail.sessionKey=t.sessionKey,PMail.k=t.k,PMail.signSk=t.signSk,e.set("fullname",t.p),e.set("isLoggedIn",!0),this.transitionTo("inbox")):e.set("errorMessage","Bad password")},join:function(){var e=this.get("controller")
if(e.set("errorMessage",null),e.get("password")!==e.get("repeat"))return e.set("errorMessage","Passwords do not match !"),void 0
var t=joinUser(e.get("username"),e.get("password"))
t&&t.sk&&t.sessionKey?(PMail.username=e.get("username"),PMail.sk=t.sk,PMail.sessionNonce=t.sessionNonce,PMail.sessionKey=t.sessionKey,PMail.k=t.k,PMail.signSk=t.signSk,e.set("isLoggedIn",!0),this.transitionTo("inbox")):e.set("errorMessage","Cannot create that account")}}}),PMail.InboxRoute=Em.Route.extend({beforeModel:function(){PMail.sk||this.transitionTo("login"),PMail.searchindex=lunr(function(){this.field("subject",{boost:3}),this.field("body"),this.field("from"),this.field("to"),this.field("date"),this.ref("id")})},model:function(){return this.store.find("inbox",{req:encodeRequest({limit:10,username:PMail.username})})},actions:{search:function(){var e=this.get("controller"),t=e.get("searchTXT")
if(!t||""===t)return e.set("model",this.store.all("inbox")),void 0
var o=this.store.all("inbox"),i=[]
PMail.searchindex.search(t).forEach(function(e){i.push(e.ref)}),o.forEach(function(e){$.inArray(e.id,i)>-1?e.set("visible",!0):e.set("visible",!1)}),this.get("controller").set("model",o.filterBy("visible",!0))}}}),PMail.InboxController=Ember.ArrayController.extend({searchTXT:null}),PMail.InboxSerializer=DS.RESTSerializer.extend({normalizePayload:function(e,t){var o=decodeResponse(t)
return decodeMail(o.inboxes),o}}),PMail.InboxMailRoute=Em.Route.extend({beforeModel:function(){PMail.sk||this.transitionTo("login")},model:function(e){return this.store.find("inbox",e.mail_id)}}),PMail.InboxMailController=Ember.ObjectController.extend({actions:{reply:function(){var e=this.get("model.from"),t=this.get("model.subject"),o=this.get("model.body")
PMail.composeMail={to:e[0].address,subject:/^re:(.*)/i.exec(t)?t:"Re: "+t,body:"<br><hr>"+e[0].address+" wrote:<div>"+o+"</div>"},this.transitionToRoute("compose")},replyAll:function(){var e=[this.get("model.from")[0].address],t=this.get("model.from"),o=this.get("model.subject"),i=this.get("model.body"),n=this.get("model.to")
for(var s in n)if(n.hasOwnProperty(s)){var r=n[s].address;-1===e.indexOf(r)&&e.push(r)}e=e.join(", "),PMail.composeMail={to:e,subject:/^re:(.*)/i.exec(o)?o:"Re: "+o,body:"<br><hr>"+t[0].address+" wrote:<div>"+i+"</div>"},this.transitionToRoute("compose")},forward:function(){var e=this.get("model.from"),t=this.get("model.subject"),o=this.get("model.body")
PMail.composeMail={to:"",subject:/^fw:(.*)/i.exec(t)?t:"Fw: "+t,body:"<br><hr>"+e[0].address+" wrote:<div>"+o+"</div>"},this.transitionToRoute("compose")}}}),PMail.SentRoute=Em.Route.extend({beforeModel:function(){PMail.sk||this.transitionTo("login")},model:function(){return this.store.find("sent",{req:encodeRequest({limit:10,username:PMail.username})})}}),PMail.SentSerializer=DS.RESTSerializer.extend({normalizePayload:function(e,t){var o=decodeResponse(t)
return decodeMail(o.sents),o}}),Ember.Handlebars.helper("maillist",function(e){return PMail.recipentListToString(e)||"Unknown"}),PMail.ComposeRoute=Em.Route.extend({beforeModel:function(){PMail.sk||this.transitionTo("login")},model:function(){var e=Ember.Object.create({to:"",subject:"",body:""})
return PMail.composeMail&&e.setProperties({to:PMail.composeMail.to||"",subject:PMail.composeMail.subject||"",body:PMail.composeMail.body||""}),e}}),PMail.ComposeView=Ember.View.extend({didInsertElement:function(){Ember.$("#inputBody").val(this.get("controller.model.body")).cleditor().focus()}}),PMail.ComposeController=Ember.ObjectController.extend({toInError:!1,actions:{send:function(){var e=this
this.set("toInError",!1)
var t=e.get("model.to")
if(t&&t.length>0){t=t.split(",")
for(var o=0;o<t.length;o++)t[o]={address:t[o].trim()}
var i=Ember.$("#inputBody").cleditor()[0].doc.body
newMail({to:t,from:[{address:PMail.username}],subject:e.get("model.subject"),text:i.innerText,html:i.innerHTML,headers:{date:new Date}}).done(function(){PMail.composeMail&&delete PMail.composeMail,e.transitionToRoute("inbox")})}else e.set("toInError",!0)}}}),PMail.ProfileController=Ember.ObjectController.extend({needs:"application",fullname:Ember.computed.alias("controllers.application.fullname"),actions:{send:function(){var e=this.get("fullname")
e&&e.length>2&&updateUser(e)}}}),PMail.ProfileRoute=Em.Route.extend({beforeModel:function(){PMail.sk||this.transitionTo("login")}}),PMail.recipentListToString=function(e){if(!e||!$.isArray(e))return null
var t=(e[0].name||"")+" <"+e[0].address+">"
return e.length>1&&e.slice(1).forEach(function(e){t+=","+(e.name||"")+" <"+e.address+">"}),t},PMail.ClearSearchView=Ember.View.extend({tagName:"span",classNames:["input-icon","fui-cross"],click:function(){var e=this.get("controller")
e.set("searchTXT",""),e.set("model",e.store.all("inbox"))}}),PMail.Inbox=DS.Model.extend({body:DS.attr(),subject:DS.attr(),from:DS.attr(),to:DS.attr(),date:DS.attr("date"),visible:DS.attr("boolean")}),PMail.Sent=DS.Model.extend({body:DS.attr(),subject:DS.attr(),from:DS.attr(),to:DS.attr(),date:DS.attr("date"),visible:DS.attr("boolean")})
